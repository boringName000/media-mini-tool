# äº‘å‡½æ•°æ•°æ®åº“æœåŠ¡æ—¶é—´è¦†ç›–å®ç°æ€»ç»“

## ğŸ“‹ **åŠŸèƒ½æ¦‚è¿°**

ä¿®æ”¹äº† `update-account-earnings` äº‘å‡½æ•°ï¼Œåœ¨æœ€ç»ˆæ›´æ–°æ”¶ç›Šè®°å½•æ—¶å¼ºåˆ¶ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´è¦†ç›–ç»“ç®—æ—¶é—´ï¼Œå¹¶å¼ºåˆ¶è®¾ç½®ä¸ºå·²ç»“ç®—çŠ¶æ€ã€‚

## ğŸ”§ **æ ¸å¿ƒä¿®æ”¹**

### **1. æœåŠ¡å™¨æ—¶é—´è¦†ç›–**

#### **ä¿®æ”¹å‰**

```javascript
// æ›´æ–°æ”¶ç›Šè®°å½•
const updatedEarning = {
  ...earnings[earningIndex],
  ...updateFields,
  // ç¡®ä¿æ—¶é—´å­—æ®µä¸è¢«è¦†ç›–
  startTime: earnings[earningIndex].startTime,
  endTime: earnings[earningIndex].endTime,
};
```

#### **ä¿®æ”¹å**

```javascript
// æ›´æ–°æ”¶ç›Šè®°å½•
const updatedEarning = {
  ...earnings[earningIndex],
  ...updateFields,
  // ç¡®ä¿æ—¶é—´å­—æ®µä¸è¢«è¦†ç›–
  startTime: earnings[earningIndex].startTime,
  endTime: earnings[earningIndex].endTime,
  // å¼ºåˆ¶è®¾ç½®ä¸ºå·²ç»“ç®—çŠ¶æ€
  settlementStatus: 2,
  // ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´
  settlementTime: db.serverDate(),
};
```

### **2. æ•°æ®æ›´æ–°é€»è¾‘**

#### **æ›´æ–°æµç¨‹**

```javascript
// 1. åˆ›å»ºæ›´æ–°åçš„æ”¶ç›Šè®°å½•
const updatedEarning = {
  ...earnings[earningIndex],
  ...updateFields,
  settlementTime: db.serverDate(), // æ•°æ®åº“æœåŠ¡æ—¶é—´
  settlementStatus: 2, // å·²ç»“ç®—çŠ¶æ€
};

// 2. æ›´æ–°earningsæ•°ç»„
earnings[earningIndex] = updatedEarning;

// 3. æ›´æ–°è´¦å·æ•°æ®
accounts[accountIndex] = {
  ...account,
  earnings: earnings,
};

// 4. æ›´æ–°æ•°æ®åº“
const updateResult = await db
  .collection("user-info")
  .where({ userId: userId })
  .update({
    data: {
      accounts: accounts,
      lastUpdateTimestamp: db.serverDate(),
    },
  });
```

## ğŸ¯ **å®ç°æ•ˆæœ**

### **1. æ—¶é—´ä¸€è‡´æ€§**

- **å®¢æˆ·ç«¯æ—¶é—´**: ç”¨æˆ·æäº¤çš„æ—¶é—´å¯èƒ½ä¸å‡†ç¡®
- **æ•°æ®åº“æœåŠ¡æ—¶é—´**: ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´ï¼Œç¡®ä¿æ—¶é—´å‡†ç¡®æ€§
- **ç»Ÿä¸€æ ‡å‡†**: æ‰€æœ‰ç»“ç®—æ—¶é—´éƒ½ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´

### **2. çŠ¶æ€å¼ºåˆ¶æ›´æ–°**

- **ç»“ç®—çŠ¶æ€**: å¼ºåˆ¶è®¾ç½®ä¸º 2ï¼ˆå·²ç»“ç®—ï¼‰
- **é˜²æ­¢é”™è¯¯**: é¿å…å®¢æˆ·ç«¯ä¼ é€’é”™è¯¯çš„çŠ¶æ€å€¼
- **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿æ‰€æœ‰ç»“ç®—è®°å½•çŠ¶æ€æ­£ç¡®

### **3. æ•°æ®å®Œæ•´æ€§**

- **æ—¶é—´å­—æ®µä¿æŠ¤**: `startTime` å’Œ `endTime` ä¸è¢«è¦†ç›–
- **æ•°æ®åº“æœåŠ¡æ—¶é—´**: `settlementTime` å’Œ `lastUpdateTimestamp` ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´
- **çŠ¶æ€å¼ºåˆ¶**: `settlementStatus` å¼ºåˆ¶ä¸ºå·²ç»“ç®—

## ğŸ“Š **å­—æ®µæ›´æ–°å¯¹æ¯”**

| å­—æ®µ                  | å®¢æˆ·ç«¯ä¼ é€’ | æœ€ç»ˆä¿å­˜       | è¯´æ˜             |
| --------------------- | ---------- | -------------- | ---------------- |
| `startTime`           | âŒ å¿½ç•¥    | åŸå€¼           | æ—¶é—´èŒƒå›´å¼€å§‹æ—¶é—´ |
| `endTime`             | âŒ å¿½ç•¥    | åŸå€¼           | æ—¶é—´èŒƒå›´ç»“æŸæ—¶é—´ |
| `settlementTime`      | âŒ å¿½ç•¥    | æ•°æ®åº“æœåŠ¡æ—¶é—´ | ç»“ç®—æ—¶é—´         |
| `lastUpdateTimestamp` | âŒ å¿½ç•¥    | æ•°æ®åº“æœåŠ¡æ—¶é—´ | ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶é—´ |
| `settlementStatus`    | âŒ å¿½ç•¥    | 2 (å·²ç»“ç®—)     | ç»“ç®—çŠ¶æ€         |
| `settlementMethod`    | âœ… ä¿ç•™    | å®¢æˆ·ç«¯å€¼       | ç»“ç®—æ–¹å¼         |
| `transferOrderNo`     | âœ… ä¿ç•™    | å®¢æˆ·ç«¯å€¼       | è½¬è´¦è®¢å•å·       |
| `accountEarnings`     | âœ… ä¿ç•™    | å®¢æˆ·ç«¯å€¼       | è´¦å·æ”¶ç›Š         |
| `settlementEarnings`  | âœ… ä¿ç•™    | å®¢æˆ·ç«¯å€¼       | ç»“ç®—æ”¶ç›Š         |
| `settlementImageUrl`  | âœ… ä¿ç•™    | å®¢æˆ·ç«¯å€¼       | ç»“ç®—å•å›¾ç‰‡       |
| `transferImageUrl`    | âœ… ä¿ç•™    | å®¢æˆ·ç«¯å€¼       | è½¬è´¦æˆªå›¾         |

## ğŸ”§ **æŠ€æœ¯ç‰¹ç‚¹**

### **1. æ—¶é—´å¤„ç†**

- **æ•°æ®åº“æœåŠ¡æ—¶é—´**: `db.serverDate()` è·å–æ•°æ®åº“æœåŠ¡æ—¶é—´
- **æ—¶åŒºå¤„ç†**: ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ‰€åœ¨æ—¶åŒºçš„æ—¶é—´
- **ç²¾åº¦**: æ¯«ç§’çº§ç²¾åº¦

### **2. çŠ¶æ€ç®¡ç†**

- **å¼ºåˆ¶è®¾ç½®**: æ— è®ºå®¢æˆ·ç«¯ä¼ é€’ä»€ä¹ˆçŠ¶æ€ï¼Œéƒ½å¼ºåˆ¶ä¸ºå·²ç»“ç®—
- **æ•°æ®å®‰å…¨**: é˜²æ­¢å®¢æˆ·ç«¯ä¼ é€’é”™è¯¯çŠ¶æ€
- **ä¸šåŠ¡é€»è¾‘**: ç¬¦åˆç»“ç®—ä¸šåŠ¡é€»è¾‘

### **3. æ•°æ®ä¿æŠ¤**

- **å…³é”®å­—æ®µ**: ä¿æŠ¤æ—¶é—´èŒƒå›´å­—æ®µä¸è¢«ä¿®æ”¹
- **ä¸šåŠ¡å­—æ®µ**: å…è®¸å®¢æˆ·ç«¯æ›´æ–°ä¸šåŠ¡ç›¸å…³å­—æ®µ
- **ç³»ç»Ÿå­—æ®µ**: ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†æ—¶é—´å’ŒçŠ¶æ€

## ğŸ“ **ä½¿ç”¨ç¤ºä¾‹**

### **å®¢æˆ·ç«¯è°ƒç”¨**

```javascript
wx.cloud.callFunction({
  name: "update-account-earnings",
  data: {
    userId: "user123",
    accountId: "account456",
    startTime: "2024-01-01T00:00:00.000Z",
    endTime: "2024-01-31T23:59:59.999Z",
    updateFields: {
      settlementTime: "2024-02-01T10:00:00.000Z", // ä¼šè¢«æ•°æ®åº“æœåŠ¡æ—¶é—´è¦†ç›–
      settlementStatus: 1, // ä¼šè¢«å¼ºåˆ¶è®¾ä¸º2
      settlementMethod: 1,
      transferOrderNo: "ORDER123456",
      accountEarnings: 2000,
      settlementEarnings: 1800,
      settlementImageUrl: "cloud://xxx.jpg",
      transferImageUrl: "cloud://xxx.jpg",
    },
  },
});
```

### **æœ€ç»ˆä¿å­˜ç»“æœ**

```javascript
{
  startTime: '2024-01-01T00:00:00.000Z',           // åŸå€¼ä¿æŒä¸å˜
  endTime: '2024-01-31T23:59:59.999Z',             // åŸå€¼ä¿æŒä¸å˜
  settlementTime: '2024-02-01T15:30:45.123Z',      // æ•°æ®åº“æœåŠ¡æ—¶é—´
  settlementStatus: 2,                              // å¼ºåˆ¶å·²ç»“ç®—
  settlementMethod: 1,                              // å®¢æˆ·ç«¯å€¼
  transferOrderNo: 'ORDER123456',                   // å®¢æˆ·ç«¯å€¼
  accountEarnings: 2000,                            // å®¢æˆ·ç«¯å€¼
  settlementEarnings: 1800,                         // å®¢æˆ·ç«¯å€¼
  settlementImageUrl: 'cloud://xxx.jpg',            // å®¢æˆ·ç«¯å€¼
  transferImageUrl: 'cloud://xxx.jpg'               // å®¢æˆ·ç«¯å€¼
}
```

## âœ… **ä¼˜åŠ¿**

1. **æ—¶é—´å‡†ç¡®æ€§**: ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´ï¼Œç¡®ä¿æ‰€æœ‰æ—¶é—´å­—æ®µçš„ä¸€è‡´æ€§
2. **çŠ¶æ€ä¸€è‡´æ€§**: å¼ºåˆ¶è®¾ç½®ä¸ºå·²ç»“ç®—çŠ¶æ€ï¼Œç¡®ä¿æ•°æ®æ­£ç¡®
3. **æ•°æ®å®‰å…¨**: ä¿æŠ¤å…³é”®å­—æ®µä¸è¢«æ„å¤–ä¿®æ”¹
4. **ä¸šåŠ¡é€»è¾‘**: ç¬¦åˆç»“ç®—ä¸šåŠ¡çš„å®é™…éœ€æ±‚
5. **ç³»ç»Ÿå¯é æ€§**: å‡å°‘å®¢æˆ·ç«¯ä¼ é€’é”™è¯¯æ•°æ®çš„é£é™©
6. **æ•°æ®åº“ä¸€è‡´æ€§**: æ‰€æœ‰æ—¶é—´å­—æ®µéƒ½ä½¿ç”¨æ•°æ®åº“æœåŠ¡æ—¶é—´ï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´

è¯¥ä¿®æ”¹ç¡®ä¿äº†ç»“ç®—æ•°æ®çš„æ—¶é—´å‡†ç¡®æ€§å’ŒçŠ¶æ€ä¸€è‡´æ€§ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯é æ€§å’Œæ•°æ®è´¨é‡ï¼ğŸš€
