# 云数据库设置和使用指南

## 概述

本项目已配置云数据库"user-info"的数据添加功能，包含 name 和 time 字段。

## 文件结构

```
miniTool/
├── cloudfunctions/
│   └── test/
│       ├── index.js          # 云函数主文件
│       ├── package.json      # 依赖配置
│       └── config.json       # 云函数配置
├── miniprogram/
│   ├── pages/
│   │   └── test-db/         # 数据库测试页面
│   │       ├── test-db.js
│   │       ├── test-db.wxml
│   │       ├── test-db.wxss
│   │       ├── test-db.json
│   │       └── README.md
│   ├── app.js               # 小程序入口文件
│   └── app.json             # 小程序配置
└── deploy-cloud-function.sh # 部署脚本
```

## 设置步骤

### 1. 云开发环境配置

确保在微信开发者工具中：

- 已开通云开发服务
- 已创建云环境
- 已创建"user-info"数据库集合

### 2. 部署云函数

在项目根目录执行：

```bash
./deploy-cloud-function.sh
```

或者手动部署：

```bash
cd cloudfunctions/test
npm install
wx cloud functions deploy test
```

### 3. 测试功能

1. 在微信开发者工具中预览小程序
2. 在首页点击"数据库测试"按钮
3. 输入用户名并点击"添加数据到数据库"
4. 查看添加结果

## 数据库字段说明

| 字段名     | 类型   | 说明                     |
| ---------- | ------ | ------------------------ |
| name       | String | 用户名（用户输入）       |
| time       | Date   | 当前时间（自动生成）     |
| openid     | String | 用户 OpenID（自动获取）  |
| appid      | String | 小程序 AppID（自动获取） |
| unionid    | String | 用户 UnionID（自动获取） |
| createTime | Date   | 服务器时间戳（自动生成） |

## 云函数功能

`cloudfunctions/test/index.js` 云函数提供以下功能：

1. **接收参数**：接收前端传递的用户名
2. **自动填充**：自动添加时间戳和用户信息
3. **数据库操作**：向"user-info"集合插入数据
4. **错误处理**：包含完整的错误处理机制
5. **返回结果**：返回操作状态和插入的文档 ID

## 前端页面功能

`miniprogram/pages/test-db/` 测试页面提供：

1. **用户输入**：用户名输入框
2. **数据提交**：调用云函数添加数据
3. **结果展示**：显示添加结果和详细信息
4. **错误提示**：友好的错误提示信息

## 注意事项

1. **权限设置**：确保"user-info"集合的读写权限已正确配置
2. **环境变量**：云函数使用`cloud.DYNAMIC_CURRENT_ENV`自动获取当前环境
3. **用户授权**：需要用户授权才能获取 OpenID 等信息
4. **网络连接**：确保网络连接正常

## 故障排除

### 常见问题

1. **云函数调用失败**

   - 检查云函数是否已正确部署
   - 检查云开发环境是否正确配置

2. **数据库操作失败**

   - 检查"user-info"集合是否已创建
   - 检查数据库权限设置

3. **用户信息获取失败**
   - 检查用户是否已授权
   - 检查小程序是否已正确配置

### 调试方法

1. 查看云函数日志：在云开发控制台查看云函数执行日志
2. 查看前端日志：在微信开发者工具控制台查看前端日志
3. 检查网络请求：在开发者工具的网络面板查看请求详情

## 扩展功能

如需添加更多字段或功能，可以：

1. 修改云函数中的`userData`对象
2. 在前端页面添加对应的输入字段
3. 更新数据库集合的字段结构

## 联系支持

如有问题，请检查：

1. 微信开发者工具版本
2. 云开发服务状态
3. 网络连接状态
