# admin-user-dashboard 云函数

## 功能描述

管理员用户仪表盘数据统计云函数，用于获取用户相关的各种统计数据，为管理端仪表盘提供数据支持。

## 主要功能

1. **总用户数量统计** - 统计 user-info 集合中的用户总数
2. **活跃用户统计** - 根据 lastUpdateTimestamp 字段统计最近7天每日活跃用户数
3. **任务完成统计** - 根据每个账号的 dailyTasks 中的 isCompleted 字段统计今日完成任务的账号数
4. **账号绑定统计** - 统计未绑定公众号账号的用户数（accounts 字段为空）
5. **用户增长趋势** - 根据 registerTimestamp 字段统计最近7天每日用户注册数量
6. **文章发布趋势** - 根据用户账号的 posts 数据统计最近7天每日文章发布数量
7. **多账号用户统计** - 统计绑定多个公众号账号的用户数（accounts 字段长度大于1）

## 请求参数

无需传入参数，云函数会自动查询所有用户数据进行统计。

## 返回数据结构

```javascript
{
  success: Boolean,
  message: String,
  data: {
    // 1. 总用户数量
    totalUsers: Number,
    
    // 2. 最近7天每日活跃用户数
    activeUsersLast7Days: [
      {
        date: "2025-09-07",  // 日期
        count: 15            // 当日活跃用户数
      },
      // ... 7天数据
    ],
    
    // 3. 今日完成任务的账号数
    todayCompletedTasksCount: Number,
    
    // 4. 未绑定公众号账号的用户数
    usersWithoutAccounts: Number,
    
    // 5. 最近7天每日用户注册数量
    userRegistrationsLast7Days: [
      {
        date: "2025-09-07",  // 日期
        count: 5             // 当日注册用户数
      },
      // ... 7天数据
    ],
    
    // 6. 最近7天每日文章发布数量
    articlePublishLast7Days: [
      {
        date: "2025-09-07",  // 日期
        count: 25            // 当日发布文章数
      },
      // ... 7天数据
    ],
    
    // 7. 绑定多个公众号账号的用户数
    usersWithMultipleAccounts: Number,
    
    // 额外统计信息
    statistics: {
      totalAccounts: Number,           // 总账号数
      averageAccountsPerUser: String,  // 平均每用户账号数
      usersWithAccounts: Number        // 有绑定账号的用户数
    }
  },
  timestamp: String,  // 统计时间
  openid: String,
  appid: String,
  unionid: String
}
```

## 数据来源

- **user-info 集合**: 所有用户数据的主要来源
- **lastUpdateTimestamp**: 用户最后更新时间，用于活跃用户统计
- **registerTimestamp**: 用户注册时间，用于注册趋势统计
- **accounts 数组**: 用户绑定的公众号账号信息
- **dailyTasks 数组**: 每个账号的每日任务信息
- **posts 数组**: 每个账号发布的文章信息

## 时间范围说明

- **最近7天**: 从当前日期往前推7天（包含今天）
- **今日**: 当前日期的0点到23:59:59
- **日期格式**: 返回的日期使用 "YYYY-MM-DD" 格式

## 使用场景

1. **管理端仪表盘**: 为管理端首页提供核心统计数据
2. **用户分析**: 分析用户活跃度、增长趋势等
3. **任务监控**: 监控用户任务完成情况
4. **账号管理**: 了解用户账号绑定情况

## 性能优化策略

云函数采用**智能双策略**设计，根据数据规模自动选择最优的查询方式：

### 小规模数据策略 (< 5000 用户)
- **方法**: 一次性获取所有用户数据，在内存中进行统计计算
- **优势**: 
  - 网络请求次数少，总体延迟低
  - 逻辑简单，易于维护和调试
  - 适合快速响应的场景
- **适用场景**: 初期项目、中小型应用

### 大规模数据策略 (≥ 5000 用户)
- **方法**: 使用数据库聚合查询和并行处理
- **优势**:
  - 内存占用小，避免云函数内存限制
  - 数据库层面处理，计算效率高
  - 网络传输数据量小
- **技术特点**:
  - 并行执行多个聚合查询
  - 使用 MongoDB 聚合管道优化
  - 复杂嵌套数组查询采用混合策略

### 性能对比分析

| 数据规模 | 内存策略 | 聚合策略 | 推荐方案 |
|---------|---------|---------|---------|
| < 1000用户 | ✅ 快速 | ❌ 过度设计 | 内存策略 |
| 1000-5000用户 | ✅ 可接受 | ✅ 稳定 | 内存策略 |
| 5000-20000用户 | ❌ 内存压力 | ✅ 高效 | 聚合策略 |
| > 20000用户 | ❌ 可能超限 | ✅ 必须 | 聚合策略 |

### 进一步优化建议

1. **缓存机制**: 统计结果可缓存5-15分钟
2. **定时预计算**: 可考虑定时任务预计算统计数据
3. **分片查询**: 超大规模数据可考虑分片并行查询
4. **索引优化**: 确保时间字段建立适当索引

## 错误处理

云函数包含完整的错误处理机制，当发生错误时会返回：

```javascript
{
  success: false,
  error: "错误描述",
  code: "DASHBOARD_ERROR",
  details: "详细错误信息",
  openid: String,
  appid: String,
  unionid: String
}
```

## 版本历史

- **v1.0**: 初始版本，实现基础的用户仪表盘数据统计功能